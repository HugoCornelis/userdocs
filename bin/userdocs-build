#!/usr/bin/perl -w
#!/usr/bin/perl -w -d:ptkdb
#


use strict;


use YAML;


sub build_document
{
    my $document = shift;

#     $document = m((.*)/(.*));

    my $directory = $document;

#     my $filename = $2;

    chdir $directory;

    # if we find a makefile

    if (-f 'Makefile')
    {
	# that is what we use

	system "make";
    }
    else
    {
	# find relevant source files

	my $filenames
	    = [
	       map
	       {
		   chomp; $_
	       }
	       `ls *.tex`,
	      ];

	# loop over source files

	foreach my $filename (@$filenames)
	{
	    # for latex sources

	    if ($filename =~ /\.tex$/)
	    {
		# prepare output: general latex processing

		$filename =~ m((.*)\.tex$);

		my $filename_base = $1;

		system "latex '$filename'";

		system "makeindex -c '$filename_base'";

		system "bibtex '$filename_base'";

		system "latex '$filename'";
		system "latex '$filename'";

		# generate ps output

		{
		    mkdir "output_ps";

		    chdir "output_ps";

		    system "dvips '../$filename_base.dvi' -o '$filename_base.ps'";

		    chdir "..";
		}

		# generate pdf output

		{
		    mkdir "output_pdf";

		    chdir "output_pdf";

		    system "ps2pdf '../output_ps/$filename_base.ps' '$filename_base.pdf'";

		    chdir "..";
		}

		# generate html output

		{
		    mkdir 'output_html';

		    chdir "output_html";

		    # read latex source

		    use IO::File;

		    my $source_file = IO::File->new("<../$filename");

		    my $source_text = join "", <$source_file>;

		    $source_file->close();

		    # convert pdf links to html links

		    $source_text =~ s(\\href\{../([^}])*\.pdf)(\\href\{../$1.html)g;

		    # write converted source

		    $source_file = IO::File->new(">$filename");

		    print $source_file $source_text;

		    $source_file->close();

		    # generate html output

		    system "htlatex '$filename'";

		    chdir "..";
		}
	    }

	    # else unknown source file type

	    else
	    {
		print "$0: unknown file type for $filename";
	    }
	}
    }

    chdir '..';
}


sub main
{
    my $source = '.';

    my $tag = $ARGV[0];

    if (!defined $tag)
    {
	die "$0: please give a tag value on the command line";
    }

    my $documents_yaml = `userdocs-tag-filter 2>&1 "$tag"`;

    my $documents = Load($documents_yaml);

    foreach my $document (@$documents)
    {
	build_document($document);
    }
}


main();


